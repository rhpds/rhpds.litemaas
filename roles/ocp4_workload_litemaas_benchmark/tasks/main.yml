---
# =============================================================================
# LiteMaaS Benchmark Workload - Main Entry Point
# =============================================================================
# Runs multi-turn conversation benchmarks to validate LiteMaaS performance
# and prefix caching effectiveness.
#
# Requirements:
#   - rhpds.litellm_virtual_keys workload must run first
#   - OpenShift cluster must be available
#
# Usage:
#   - Run as post-deployment workload
#   - Configured via catalog parameters
#   - Results saved to agnosticd_user_info
# =============================================================================

# Set ACTION from agnosticd_action if not defined
- name: Set ACTION from agnosticd_action if not defined
  ansible.builtin.set_fact:
    ACTION: "{{ agnosticd_action | default(ACTION | default('provision')) }}"
  when: ACTION is not defined or agnosticd_action is defined

# -----------------------------------------------------------------------------
# Provision Action (create/provision)
# -----------------------------------------------------------------------------
- name: Running Workload Tasks
  when: ACTION == "create" or ACTION == "provision"
  block:
    - name: Skip benchmark if disabled
      when: not ocp4_workload_litemaas_benchmark_enabled | default(false) | bool
      block:
        - name: Log benchmark skip
          ansible.builtin.debug:
            msg: "LiteMaaS benchmark disabled, skipping"

        - name: End play for this host
          ansible.builtin.meta: end_host

    - name: Run LiteMaaS benchmark
      when: ocp4_workload_litemaas_benchmark_enabled | default(false) | bool
      include_tasks:
        file: ./workload.yml

# -----------------------------------------------------------------------------
# Destroy Action (destroy/remove)
# -----------------------------------------------------------------------------
- name: Running Workload removal Tasks
  when: ACTION == "destroy" or ACTION == "remove"
  include_tasks:
    file: ./remove_workload.yml
