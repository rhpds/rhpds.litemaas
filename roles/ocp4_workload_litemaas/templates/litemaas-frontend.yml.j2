---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: litemaas-frontend
  labels:
    app: litemaas-frontend
    component: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: litemaas-frontend
  template:
    metadata:
      labels:
        app: litemaas-frontend
        component: web
    spec:
      initContainers:
        - name: wait-for-backend
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for backend to be ready..."
              until nc -z litemaas-backend 8080; do
                echo "Backend is not ready yet. Waiting..."
                sleep 5
              done
              echo "Backend is ready! Starting frontend..."
{% if ocp4_workload_litemaas_branding_enabled | default(false) | bool %}
        # Inject RHDP branding directly into frontend files
        - name: setup-branding
          image: "{{ ocp4_workload_litemaas_frontend_image }}:{{ ocp4_workload_litemaas_version }}"
          command:
            - sh
            - -c
            - |
              set -e
              echo "=== RHDP Branding: Starting setup ==="

              # Copy original frontend files to shared volume
              echo "Copying frontend files to shared volume..."
              cp -r /opt/app-root/src/* /app-volume/

              # Copy branding assets (logos, favicon)
              echo "Copying branding assets..."
              mkdir -p /app-volume/branding
              cp /branding-source/logo-light.svg /app-volume/branding/
              cp /branding-source/logo-dark.svg /app-volume/branding/
              cp /branding-source/favicon.png /app-volume/branding/

              # Find index.html
              INDEX_FILE=$(find /app-volume -name "index.html" | head -1)
              if [ -z "$INDEX_FILE" ]; then
                echo "ERROR: index.html not found!"
                exit 1
              fi
              echo "Found index.html at: $INDEX_FILE"

              # Inject preload CSS into <head> BEFORE any other content
              echo "Injecting preload CSS..."
              sed -i 's|<head>|<head><style id="rhdp-preload-css">body{visibility:hidden!important}body.rhdp-ready{visibility:visible!important}img[src*="logo"],img[alt*="LiteMaaS"]{opacity:0!important}img[src*="/branding/logo-"]{opacity:1!important}h1,h2,h3,h4,h5,h6{opacity:0!important}.rhdp-branded{opacity:1!important}footer,[class*="footer"]:not(#rhdp-footer){display:none!important}</style>|' "$INDEX_FILE"

              # Inject branding script before </head>
              echo "Injecting branding script..."
              sed -i 's|</head>|<script src="/branding/branding-inject.js"></script></head>|' "$INDEX_FILE"

              # Replace favicon references
              echo "Replacing favicon..."
              sed -i 's|<link[^>]*rel="icon"[^>]*>|<link rel="icon" type="image/png" href="/branding/favicon.png">|g' "$INDEX_FILE"

              # Copy branding script
              cp /branding-source/branding-inject.js /app-volume/branding/

              echo "=== RHDP Branding: Setup complete ==="
              echo "Modified index.html:"
              head -20 "$INDEX_FILE"
          volumeMounts:
            - name: branding-source
              mountPath: /branding-source
              readOnly: true
            - name: app-volume
              mountPath: /app-volume
{% endif %}
      containers:
        - name: frontend
          image: "{{ ocp4_workload_litemaas_frontend_image }}:{{ ocp4_workload_litemaas_version }}"
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: BACKEND_URL
              value: "http://litemaas-backend:8080"
{% if ocp4_workload_litemaas_branding_enabled | default(false) | bool %}
          volumeMounts:
            - name: app-volume
              mountPath: /opt/app-root/src
{% endif %}
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "{{ ocp4_workload_litemaas_frontend_memory_limit }}"
              cpu: "{{ ocp4_workload_litemaas_frontend_cpu_limit }}"
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
{% if ocp4_workload_litemaas_branding_enabled | default(false) | bool %}
      volumes:
        - name: branding-source
          configMap:
            name: litemaas-branding
        - name: app-volume
          emptyDir: {}
{% endif %}
---
apiVersion: v1
kind: Service
metadata:
  name: litemaas-frontend
  labels:
    app: litemaas-frontend
    component: web
spec:
  ports:
    - port: 8080
      targetPort: 8080
      name: http
  selector:
    app: litemaas-frontend
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: litemaas-frontend
  labels:
    app: litemaas-frontend
    component: web
spec:
  host: "litellm-frontend.{{ ocp4_workload_litemaas_cluster_domain }}"
  to:
    kind: Service
    name: litemaas-frontend
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
