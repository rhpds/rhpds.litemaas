---
apiVersion: v1
kind: ConfigMap
metadata:
  name: litemaas-branding
  namespace: {{ _litemaas_ha_namespace | default(ocp4_workload_litemaas_namespace) }}
  labels:
    app: litemaas
    component: branding
data:
  # Red Hat Demo Platform logo (light/black version for light theme)
  logo-light.svg: |
{% if ocp4_workload_litemaas_branding_logo_light_path != "" %}
{{ lookup('file', ocp4_workload_litemaas_branding_logo_light_path) | indent(4, first=True) }}
{% else %}
{{ lookup('file', 'Logo-Red_Hat-Demo_Platform_Team-A-Black-RGB.svg') | indent(4, first=True) }}
{% endif %}

  # Red Hat Demo Platform logo (dark/white version for dark theme)
  logo-dark.svg: |
{% if ocp4_workload_litemaas_branding_logo_dark_path != "" %}
{{ lookup('file', ocp4_workload_litemaas_branding_logo_dark_path) | indent(4, first=True) }}
{% else %}
{{ lookup('file', 'Logo-Red_Hat-Demo_Platform_Team-A-White-RGB.svg') | indent(4, first=True) }}
{% endif %}

  # Red Hat favicon (tab icon)
  favicon.png: |
{% if ocp4_workload_litemaas_branding_favicon_path != "" %}
{{ lookup('file', ocp4_workload_litemaas_branding_favicon_path) | b64encode | indent(4, first=True) }}
{% else %}
{{ lookup('file', 'Red_Hat_logo.png') | b64encode | indent(4, first=True) }}
{% endif %}

  # Branding injection script
  branding-inject.js: |
    (function() {
      console.log('RHDP Branding: Initializing...');

      // Add CSS to hide elements until branding loads (prevents flash)
      const style = document.createElement('style');
      style.textContent = `
        /* Hide LiteMaaS branding until RHDP branding loads */
        img[src*="logo"], img[alt*="LiteMaaS"], img[alt*="litemaas"] {
          opacity: 0 !important;
          transition: opacity 0.3s ease-in-out;
        }
        img[src*="/branding/logo-"] {
          opacity: 1 !important;
        }
        /* Hide original footer */
        footer, [class*="footer"] {
          display: none !important;
        }
        #rhdp-branding-footer {
          display: block !important;
        }
      `;
      document.head.appendChild(style);

      // Configuration
      const LOGO_LIGHT_PATH = '/branding/logo-light.svg';
      const LOGO_DARK_PATH = '/branding/logo-dark.svg';
      const FAVICON_PATH = '/branding/favicon.png';
      const SERVICE_TEXT = '{{ ocp4_workload_litemaas_branding_service_text }}';
      const ENABLE_FOOTER_TEXT = {{ ocp4_workload_litemaas_branding_enable_footer | default('true') | lower }};
      const OAUTH_ENABLED = {{ ocp4_workload_litemaas_oauth_enabled | default('false') | lower }};

      // Wait for DOM to be ready
      function init() {
        console.log('RHDP Branding: Replacing logo...');
        replaceLogo();
        replaceFavicon();
        replacePageTitle();

        if (ENABLE_FOOTER_TEXT) {
          console.log('RHDP Branding: Adding Red Hat footer...');
          addRedHatFooter();
        }

        if (!OAUTH_ENABLED) {
          console.log('RHDP Branding: Hiding OAuth login (OAuth disabled)...');
          hideOAuthLogin();
        }

        // Watch for theme changes
        observeThemeChanges();
      }

      // Replace page title and headings
      function replacePageTitle() {
        // Replace page title
        document.title = 'MaaS - Red Hat Demo Platform';

        // Replace "Log in to LiteMaaS" heading
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(heading => {
          if (heading.textContent.includes('Log in to LiteMaaS') || heading.textContent.includes('Welcome to LiteMaaS')) {
            heading.textContent = 'Login to MaaS provided by Red Hat Demo Platform';
            console.log('RHDP Branding: Replaced heading:', heading);
          }
        });

        console.log('RHDP Branding: Page title updated');
      }

      // Replace LiteMaaS logo with RHDP logo
      function replaceLogo() {
        const logoSelectors = [
          'img[src*="logo"]',
          'img[alt*="LiteMaaS"]',
          'img[alt*="litemaas"]',
          '[class*="logo"] img',
          '[class*="Logo"] img'
        ];

        logoSelectors.forEach(selector => {
          const logos = document.querySelectorAll(selector);
          logos.forEach(img => {
            const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
            const newSrc = isDarkTheme ? LOGO_DARK_PATH : LOGO_LIGHT_PATH;

            // Only replace if not already using RHDP logo
            if (!img.src.includes('/branding/logo-')) {
              console.log('RHDP Branding: Replacing logo element:', img);
              img.src = newSrc;
              img.alt = 'Red Hat Demo Platform';

              // Ensure proper sizing
              if (!img.style.height) {
                img.style.height = '40px';
              }
            }
          });
        });
      }

      // Replace favicon with Red Hat logo
      function replaceFavicon() {
        // Remove existing favicons
        const existingIcons = document.querySelectorAll('link[rel*="icon"]');
        existingIcons.forEach(icon => icon.remove());

        // Add Red Hat favicon
        const favicon = document.createElement('link');
        favicon.rel = 'icon';
        favicon.type = 'image/png';
        favicon.href = FAVICON_PATH;
        document.head.appendChild(favicon);

        console.log('RHDP Branding: Favicon replaced');
      }

      // Add Red Hat footer with links
      function addRedHatFooter() {
        // Check if footer already exists
        if (document.getElementById('rhdp-branding-footer')) {
          return;
        }

        const currentYear = new Date().getFullYear();
        const footer = document.createElement('div');
        footer.id = 'rhdp-branding-footer';
        footer.style.cssText = `
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          padding: 12px 24px;
          background-color: #151515;
          color: #ffffff;
          text-align: center;
          font-size: 12px;
          font-family: "Red Hat Text", "Overpass", overpass, helvetica, arial, sans-serif;
          z-index: 1000;
          border-top: 3px solid #EE0000;
        `;

        footer.innerHTML = `
          <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div style="color: #C9C9C9; font-size: 11px;">
              Copyright Â© ${currentYear} Red Hat, Inc.
            </div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
              <a href="https://www.redhat.com/en/about/privacy-policy" target="_blank" style="color: #ffffff; text-decoration: none; font-size: 12px; transition: color 0.2s;" onmouseover="this.style.color='#EE0000'" onmouseout="this.style.color='#ffffff'">Privacy statement</a>
              <span style="color: #6A6E73;">|</span>
              <a href="https://www.redhat.com/en/about/terms-use" target="_blank" style="color: #ffffff; text-decoration: none; font-size: 12px; transition: color 0.2s;" onmouseover="this.style.color='#EE0000'" onmouseout="this.style.color='#ffffff'">Terms of use</a>
              <span style="color: #6A6E73;">|</span>
              <a href="https://www.redhat.com/en/about/all-policies-guidelines" target="_blank" style="color: #ffffff; text-decoration: none; font-size: 12px; transition: color 0.2s;" onmouseover="this.style.color='#EE0000'" onmouseout="this.style.color='#ffffff'">All policies and guidelines</a>
              <span style="color: #6A6E73;">|</span>
              <a href="https://github.com/rh-aiservices-bu/litemaas" target="_blank" style="color: #ffffff; text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s;" onmouseover="this.style.color='#EE0000'" onmouseout="this.style.color='#ffffff'">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                Source on GitHub
              </a>
            </div>
          </div>
        `;

        document.body.appendChild(footer);

        // Add padding to page content to prevent overlap
        const pageContent = document.querySelector('[class*="pf-v6-c-page__main"]');
        if (pageContent) {
          pageContent.style.paddingBottom = '60px';
        }

        console.log('RHDP Branding: Red Hat footer added');
      }

      // Hide OAuth login button when OAuth is disabled
      function hideOAuthLogin() {
        // Common selectors for OAuth login buttons
        const oauthButtonSelectors = [
          'button:contains("OpenShift")',
          'button:contains("Sign in with")',
          'a:contains("Login with")',
          '[class*="oauth"]',
          '[class*="sso"]'
        ];

        // Hide OAuth login elements
        const hideElements = () => {
          // Find buttons/links with OAuth-related text
          const allButtons = document.querySelectorAll('button, a');
          allButtons.forEach(el => {
            const text = el.textContent.toLowerCase();
            if (text.includes('openshift') || text.includes('sign in with') || text.includes('login with')) {
              console.log('RHDP Branding: Hiding OAuth element:', el);
              el.style.display = 'none';
            }
          });

          // Show message that OAuth is disabled
          const loginContainer = document.querySelector('[class*="login"]') || document.querySelector('main');
          if (loginContainer) {
            const notice = document.createElement('div');
            notice.style.cssText = 'padding: 20px; text-align: center; background: #f5f5f5; border-radius: 8px; margin: 20px;';
            notice.innerHTML = '<p style="color: #666; font-size: 14px;">OAuth authentication is disabled. Please use the LiteLLM Admin UI to manage models and API keys.</p>';
            loginContainer.prepend(notice);
          }
        };

        // Run immediately and on mutations
        hideElements();
        const observer = new MutationObserver(hideElements);
        observer.observe(document.body, { childList: true, subtree: true });

        console.log('RHDP Branding: OAuth login hidden');
      }

      // Observe theme changes and update logo accordingly
      function observeThemeChanges() {
        const observer = new MutationObserver(() => {
          replaceLogo();
        });

        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-theme']
        });
      }

      // Run initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // Re-run on navigation (for SPA) and DOM changes
      let lastUrl = location.href;
      const observer = new MutationObserver(() => {
        const url = location.href;
        if (url !== lastUrl) {
          lastUrl = url;
          console.log('RHDP Branding: URL changed, re-applying branding...');
          setTimeout(init, 100); // Small delay for React to render
        }
        // Also re-apply logo and title on any DOM changes (React re-renders)
        replaceLogo();
        replacePageTitle();
      });

      // Only observe if body exists
      if (document.body) {
        observer.observe(document.body, {
          subtree: true,
          childList: true,
          attributes: false
        });
      }

      // Also run periodically to catch any missed changes
      setInterval(() => {
        replaceLogo();
        replacePageTitle();
      }, 2000);

      console.log('RHDP Branding: Initialization complete');
    })();

  # nginx config snippet to serve branding assets
  nginx-branding.conf: |
    # Serve branding assets
    location /branding/ {
      alias /usr/share/nginx/html/branding/;
      expires 1h;
      add_header Cache-Control "public, immutable";
    }
