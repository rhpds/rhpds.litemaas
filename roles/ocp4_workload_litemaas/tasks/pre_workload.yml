---
# Pre-flight checks and setup - Cloud Agnostic

- name: Display pre-flight header
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "LiteMaaS Pre-flight Checks"
      - "========================================="

- name: Ensure required variables are set
  ansible.builtin.assert:
    that:
      - ocp4_workload_litemaas_namespace is defined
      - ocp4_workload_litemaas_version is defined
    fail_msg: "Required variables are not set"
    quiet: true

- name: Check cluster connectivity
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: default
  register: r_cluster_check
  failed_when: r_cluster_check.failed

# Cloud Provider Detection
- name: Detect cloud provider if not specified
  when: ocp4_workload_litemaas_cloud_provider == ""
  block:
    - name: Get infrastructure information
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Infrastructure
        name: cluster
      register: r_infrastructure

    - name: Set cloud provider from infrastructure
      ansible.builtin.set_fact:
        ocp4_workload_litemaas_cloud_provider: "{{ r_infrastructure.resources[0].status.platformStatus.type | lower }}"

    - name: Map platform types to cloud providers
      ansible.builtin.set_fact:
        ocp4_workload_litemaas_cloud_provider: >-
          {%- if ocp4_workload_litemaas_cloud_provider in ['aws', 'amazon'] -%}aws
          {%- elif ocp4_workload_litemaas_cloud_provider in ['azure', 'azurestack'] -%}azure
          {%- elif ocp4_workload_litemaas_cloud_provider in ['gcp', 'gce'] -%}gcp
          {%- elif ocp4_workload_litemaas_cloud_provider in ['vsphere', 'vmware'] -%}vsphere
          {%- elif ocp4_workload_litemaas_cloud_provider in ['openstack'] -%}openstack
          {%- elif ocp4_workload_litemaas_cloud_provider in ['baremetal', 'none'] -%}baremetal
          {%- else -%}{{ ocp4_workload_litemaas_cloud_provider }}
          {%- endif -%}

- name: Display detected cloud provider
  ansible.builtin.debug:
    msg: "Detected cloud provider: {{ ocp4_workload_litemaas_cloud_provider }}"

# Storage Class Auto-Detection
- name: Configure storage class based on cloud provider
  when: ocp4_workload_litemaas_postgres_storage_class == ""
  block:
    - name: Get all storage classes
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: StorageClass
      register: r_storage_classes

    - name: Try cloud-specific storage class first
      ansible.builtin.set_fact:
        _litemaas_preferred_storage_class: "{{ _ocp4_workload_litemaas_storage_class_map[ocp4_workload_litemaas_cloud_provider] | default('') }}"

    - name: Check if preferred storage class exists
      ansible.builtin.set_fact:
        _litemaas_storage_class_exists: "{{ r_storage_classes.resources | selectattr('metadata.name', 'equalto', _litemaas_preferred_storage_class) | list | length > 0 }}"
      when: _litemaas_preferred_storage_class != ""

    - name: Use preferred storage class if available
      ansible.builtin.set_fact:
        ocp4_workload_litemaas_postgres_storage_class: "{{ _litemaas_preferred_storage_class }}"
      when:
        - _litemaas_preferred_storage_class != ""
        - _litemaas_storage_class_exists | default(false)

    - name: Fall back to default storage class
      when: ocp4_workload_litemaas_postgres_storage_class == ""
      block:
        - name: Find default storage class
          ansible.builtin.set_fact:
            ocp4_workload_litemaas_postgres_storage_class: >-
              {{ r_storage_classes.resources
                 | selectattr('metadata.annotations.storageclass.kubernetes.io/is-default-class', 'defined')
                 | selectattr('metadata.annotations.storageclass.kubernetes.io/is-default-class', 'equalto', 'true')
                 | map(attribute='metadata.name')
                 | first | default('gp3-csi') }}

- name: Display storage configuration
  ansible.builtin.debug:
    msg:
      - "PostgreSQL Storage Class: {{ ocp4_workload_litemaas_postgres_storage_class }}"
      - "PostgreSQL Storage Size: {{ ocp4_workload_litemaas_postgres_storage_size }}"

# Cluster Domain Detection
- name: Auto-detect cluster domain if not provided
  when: ocp4_workload_litemaas_cluster_domain == ""
  block:
    - name: Get ingress configuration
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Ingress
        name: cluster
      register: r_ingress_config

    - name: Set cluster domain from ingress config
      ansible.builtin.set_fact:
        ocp4_workload_litemaas_cluster_domain: "{{ r_ingress_config.resources[0].spec.domain }}"

- name: Display cluster domain
  ansible.builtin.debug:
    msg: "Using cluster domain: {{ ocp4_workload_litemaas_cluster_domain }}"

# OAuth Configuration
- name: Configure OAuth based on provider
  block:
    - name: Set Google OAuth issuer
      ansible.builtin.set_fact:
        _litemaas_oauth_issuer: "https://accounts.google.com"
      when: ocp4_workload_litemaas_oauth_provider == "google"

    - name: Set OpenShift OAuth issuer
      when: ocp4_workload_litemaas_oauth_provider == "openshift"
      block:
        - name: Get OAuth server configuration
          kubernetes.core.k8s_info:
            api_version: config.openshift.io/v1
            kind: OAuth
            name: cluster
          register: r_oauth_server

        - name: Set OAuth issuer to OAuth route URL (OpenShift standard)
          ansible.builtin.set_fact:
            _litemaas_oauth_issuer: "https://oauth-openshift.{{ ocp4_workload_litemaas_cluster_domain }}"
          when: r_oauth_server.resources[0].status.issuer is not defined or r_oauth_server.resources[0].status.issuer == ""

        - name: Use OAuth issuer from cluster if explicitly configured
          ansible.builtin.set_fact:
            _litemaas_oauth_issuer: "{{ r_oauth_server.resources[0].status.issuer }}"
          when:
            - r_oauth_server.resources[0].status.issuer is defined
            - r_oauth_server.resources[0].status.issuer != ""

- name: Check if OAuth client already exists
  when:
    - ocp4_workload_litemaas_oauth_enabled | bool
    - ocp4_workload_litemaas_oauth_provider == "openshift"
  kubernetes.core.k8s_info:
    api_version: oauth.openshift.io/v1
    kind: OAuthClient
    name: "{{ ocp4_workload_litemaas_oauth_client_id }}"
  register: r_existing_oauth_client

- name: Reuse existing OAuth client secret if available
  when:
    - ocp4_workload_litemaas_oauth_enabled | bool
    - ocp4_workload_litemaas_oauth_provider == "openshift"
    - r_existing_oauth_client.resources | length > 0
  ansible.builtin.set_fact:
    _litemaas_oauth_client_secret_generated: "{{ r_existing_oauth_client.resources[0].secret }}"

- name: Generate new OAuth client secret if needed
  when:
    - ocp4_workload_litemaas_oauth_enabled | bool
    - r_existing_oauth_client.resources | default([]) | length == 0
  ansible.builtin.set_fact:
    _litemaas_oauth_client_secret_generated: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

- name: Set default OAuth client secret for non-OAuth deployments
  when:
    - not (ocp4_workload_litemaas_oauth_enabled | bool)
  ansible.builtin.set_fact:
    _litemaas_oauth_client_secret_generated: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

- name: Generate OAuth redirect URIs for LiteMaaS deployment
  when: ocp4_workload_litemaas_oauth_enabled | bool
  ansible.builtin.set_fact:
    _litemaas_oauth_redirect_uris:
      - "https://litellm-admin.{{ ocp4_workload_litemaas_cluster_domain }}/api/auth/callback"
      - "https://litellm-frontend.{{ ocp4_workload_litemaas_cluster_domain }}/api/auth/callback"

- name: Create OpenShift OAuthClient for backend
  when:
    - ocp4_workload_litemaas_oauth_enabled | bool
    - ocp4_workload_litemaas_oauth_provider == "openshift"
    - r_existing_oauth_client.resources | default([]) | length == 0
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: oauth.openshift.io/v1
      kind: OAuthClient
      metadata:
        name: "{{ ocp4_workload_litemaas_oauth_client_id }}"
      secret: "{{ _litemaas_oauth_client_secret_generated }}"
      redirectURIs: "{{ _litemaas_oauth_redirect_uris }}"
      grantMethod: prompt

- name: Display pre-flight summary
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Pre-flight Checks Complete"
      - "========================================="
      - "Cloud Provider: {{ ocp4_workload_litemaas_cloud_provider }}"
      - "Namespace: {{ ocp4_workload_litemaas_namespace }}"
      - "Version: {{ ocp4_workload_litemaas_version }}"
      - "Storage Class: {{ ocp4_workload_litemaas_postgres_storage_class }}"
      - "Cluster Domain: {{ ocp4_workload_litemaas_cluster_domain }}"
      - "OAuth Issuer: {{ _litemaas_oauth_issuer }}"
      - "========================================="
