---
# Main workload deployment tasks

- name: Display deployment header
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Deploying LiteMaaS Workload"
      - "========================================="

- name: Deploy multi-user LiteMaaS instances
  when: ocp4_workload_litemaas_multi_user | bool
  include_tasks: workload_multi_user.yml

- name: Deploy single LiteMaaS instance
  when: not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Display single instance deployment mode
      ansible.builtin.debug:
        msg:
          - "Deploying single LiteMaaS instance"
          - "Namespace: {{ ocp4_workload_litemaas_namespace }}"

- name: Create rhpds namespace
  when: not (ocp4_workload_litemaas_multi_user | bool)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ocp4_workload_litemaas_namespace }}"
        labels:
          app: litemaas
          workload: litemaas

# OAuth client creation removed - admin-only access via LiteLLM Admin UI

- name: Deploy PostgreSQL
  when: not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Create PostgreSQL secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgres-secret
            labels:
              app: postgres
          type: Opaque
          stringData:
            POSTGRES_PASSWORD: "{{ ocp4_workload_litemaas_postgres_password }}"
            DATABASE_URL: "postgresql://litemaas:{{ ocp4_workload_litemaas_postgres_password }}@postgres:5432/litemaas?sslmode=disable"

    - name: Create PostgreSQL service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: postgres
            labels:
              app: postgres
          spec:
            ports:
              - port: 5432
                targetPort: 5432
                name: postgres
            selector:
              app: postgres

    - name: Create PostgreSQL StatefulSet
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: postgres
            labels:
              app: postgres
          spec:
            serviceName: postgres
            replicas: 1
            selector:
              matchLabels:
                app: postgres
            template:
              metadata:
                labels:
                  app: postgres
              spec:
                containers:
                  - name: postgres
                    image: "postgres:{{ ocp4_workload_litemaas_postgres_version }}"
                    ports:
                      - containerPort: 5432
                        name: postgres
                    env:
                      - name: POSTGRES_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: postgres-secret
                            key: POSTGRES_PASSWORD
                      - name: POSTGRES_USER
                        value: "litemaas"
                      - name: POSTGRES_DB
                        value: "litemaas"
                      - name: PGDATA
                        value: "/var/lib/postgresql/data/pgdata"
                    command:
                      - postgres
                      - "-c"
                      - "max_connections={{ ocp4_workload_litemaas_postgres_max_connections }}"
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /var/lib/postgresql/data
                    resources:
                      limits:
                        memory: "1Gi"
                        cpu: "1000m"
                      requests:
                        memory: "512Mi"
                        cpu: "500m"
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U litemaas
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U litemaas
                      initialDelaySeconds: 10
                      periodSeconds: 5
            volumeClaimTemplates:
              - metadata:
                  name: postgres-storage
                  labels:
                    app: postgres
                spec:
                  accessModes:
                    - "{{ ocp4_workload_litemaas_postgres_storage_access_mode }}"
                  storageClassName: "{{ ocp4_workload_litemaas_postgres_storage_class }}"
                  resources:
                    requests:
                      storage: "{{ ocp4_workload_litemaas_postgres_storage_size }}"

    - name: Wait for PostgreSQL to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        label_selectors:
          - app=postgres
      register: r_postgres_pods
      until:
        - r_postgres_pods.resources | length > 0
        - r_postgres_pods.resources[0].status.phase == "Running"
      retries: 30
      delay: 10

- name: Deploy Redis Enterprise Operator and Database
  when:
    - ocp4_workload_litemaas_deploy_redis | bool
    - not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Create Redis Operator namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: redis-enterprise

    - name: Create OperatorGroup for Redis Enterprise
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1
          kind: OperatorGroup
          metadata:
            name: redis-enterprise-group
            namespace: redis-enterprise
          spec:
            targetNamespaces:
              - redis-enterprise
              - "{{ ocp4_workload_litemaas_namespace }}"

    - name: Subscribe to Redis Enterprise Operator
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: redis-enterprise-operator-cert
            namespace: redis-enterprise
          spec:
            channel: production
            name: redis-enterprise-operator-cert
            source: certified-operators
            sourceNamespace: openshift-marketplace
            installPlanApproval: Automatic

    - name: Wait for Redis Enterprise Operator to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: redis-enterprise
        label_selectors:
          - name=redis-enterprise-operator
      register: r_redis_operator
      until:
        - r_redis_operator.resources | length > 0
        - r_redis_operator.resources[0].status.readyReplicas is defined
        - r_redis_operator.resources[0].status.readyReplicas > 0
      retries: 30
      delay: 10

    - name: Create Redis Enterprise Cluster
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: app.redislabs.com/v1
          kind: RedisEnterpriseCluster
          metadata:
            name: litemaas-rec
            labels:
              app: redis-enterprise
          spec:
            nodes: 1
            persistentSpec:
              enabled: true
              storageClassName: "{{ ocp4_workload_litemaas_redis_storage_class }}"
              volumeSize: "{{ ocp4_workload_litemaas_redis_storage_size }}"
            redisEnterpriseNodeResources:
              limits:
                cpu: "{{ ocp4_workload_litemaas_redis_cpu_limit }}"
                memory: "{{ ocp4_workload_litemaas_redis_memory_limit }}"
              requests:
                cpu: 200m
                memory: 512Mi

    - name: Wait for Redis Enterprise Cluster to be ready
      kubernetes.core.k8s_info:
        api_version: app.redislabs.com/v1
        kind: RedisEnterpriseCluster
        name: litemaas-rec
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
      register: r_redis_cluster
      until:
        - r_redis_cluster.resources | length > 0
        - r_redis_cluster.resources[0].status is defined
        - r_redis_cluster.resources[0].status.state is defined
        - r_redis_cluster.resources[0].status.state == "Running"
      retries: 60
      delay: 10

    - name: Create Redis Enterprise Database
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: app.redislabs.com/v1alpha1
          kind: RedisEnterpriseDatabase
          metadata:
            name: litemaas-redis
            labels:
              app: redis-enterprise
          spec:
            redisEnterpriseCluster:
              name: litemaas-rec
            memorySize: 256MB
            databaseSecretName: redis-enterprise-secret

    - name: Wait for Redis Enterprise Database to be ready
      kubernetes.core.k8s_info:
        api_version: app.redislabs.com/v1alpha1
        kind: RedisEnterpriseDatabase
        name: litemaas-redis
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
      register: r_redis_db
      until:
        - r_redis_db.resources | length > 0
        - r_redis_db.resources[0].status is defined
        - r_redis_db.resources[0].status.status is defined
        - r_redis_db.resources[0].status.status == "active"
      retries: 30
      delay: 10

    - name: Display Redis Enterprise deployment status
      ansible.builtin.debug:
        msg: "Redis Enterprise deployed and ready for LiteLLM cache"

- name: Deploy LiteMaaS Backend
  when:
    - ocp4_workload_litemaas_deploy_backend | bool
    - not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Create backend secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: backend-secret
            labels:
              app: litemaas-backend
          type: Opaque
          stringData:
            JWT_SECRET: "{{ ocp4_workload_litemaas_jwt_secret }}"
            ADMIN_API_KEY: "{{ ocp4_workload_litemaas_admin_api_key }}"
            OAUTH_CLIENT_SECRET: "{{ ocp4_workload_litemaas_oauth_client_secret if ocp4_workload_litemaas_oauth_provider == 'google' else _litemaas_oauth_client_secret_generated }}"

    - name: Create backend deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: litemaas-backend
            labels:
              app: litemaas-backend
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: litemaas-backend
            template:
              metadata:
                labels:
                  app: litemaas-backend
              spec:
                containers:
                  - name: backend
                    image: "{{ ocp4_workload_litemaas_backend_image }}:{{ ocp4_workload_litemaas_version }}"
                    ports:
                      - containerPort: 3000
                        name: http
                    env:
                      - name: NODE_ENV
                        value: "production"
                      - name: PORT
                        value: "3000"
                      - name: NODE_TLS_REJECT_UNAUTHORIZED
                        value: "0"
                      - name: DATABASE_URL
                        valueFrom:
                          secretKeyRef:
                            name: postgres-secret
                            key: DATABASE_URL
                      - name: JWT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: backend-secret
                            key: JWT_SECRET
                      - name: ADMIN_API_KEYS
                        valueFrom:
                          secretKeyRef:
                            name: backend-secret
                            key: ADMIN_API_KEY
                      - name: OAUTH_CLIENT_ID
                        value: "{{ ocp4_workload_litemaas_oauth_client_id }}"
                      - name: OAUTH_CLIENT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: backend-secret
                            key: OAUTH_CLIENT_SECRET
                      - name: OAUTH_ISSUER
                        value: "{{ _litemaas_oauth_issuer }}"
                      - name: OAUTH_CALLBACK_URL
                        value: "https://litemaas-rhpds.{{ ocp4_workload_litemaas_cluster_domain }}/api/auth/callback"
                      - name: LITELLM_API_URL
                        value: "http://litellm:4000"
                      - name: LITELLM_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: LITELLM_MASTER_KEY
                      - name: CORS_ORIGIN
                        value: "https://litemaas-rhpds.{{ ocp4_workload_litemaas_cluster_domain }}"
                    resources:
                      limits:
                        memory: "{{ ocp4_workload_litemaas_backend_memory_limit }}"
                        cpu: "{{ ocp4_workload_litemaas_backend_cpu_limit }}"
                      requests:
                        memory: "256Mi"
                        cpu: "250m"

    - name: Create backend service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: litemaas-backend
            labels:
              app: litemaas-backend
          spec:
            ports:
              - port: 3000
                targetPort: 3000
                name: http
            selector:
              app: litemaas-backend

    - name: Create backend route (for OAuth callback and API)
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: litemaas-backend
            labels:
              app: litemaas-backend
          spec:
            host: "litemaas-rhpds.{{ ocp4_workload_litemaas_cluster_domain }}"
            path: /api
            to:
              kind: Service
              name: litemaas-backend
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect

- name: Deploy LiteLLM Gateway
  when: not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Create LiteLLM secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: litellm-secret
            labels:
              app: litellm
          type: Opaque
          stringData:
            LITELLM_MASTER_KEY: "{{ ocp4_workload_litemaas_litellm_api_key }}"
            UI_USERNAME: "{{ ocp4_workload_litemaas_litellm_ui_username }}"
            UI_PASSWORD: "{{ ocp4_workload_litemaas_litellm_ui_password }}"
            DATABASE_URL: "postgresql://litemaas:{{ ocp4_workload_litemaas_postgres_password }}@postgres:5432/litemaas?sslmode=disable"

    - name: Create LiteLLM deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: litellm
            labels:
              app: litellm
          spec:
            replicas: "{{ ocp4_workload_litemaas_litellm_replicas | int }}"
            selector:
              matchLabels:
                app: litellm
            template:
              metadata:
                labels:
                  app: litellm
                  component: ai-proxy
              spec:
                initContainers:
                  - name: wait-for-postgres
                    image: busybox:1.36
                    command:
                      - sh
                      - -c
                      - |
                        until nc -z postgres 5432; do
                          echo "Waiting for PostgreSQL..."
                          sleep 2
                        done
                        echo "PostgreSQL is ready"
                containers:
                  - name: litellm
                    image: "{{ ocp4_workload_litemaas_litellm_image }}:{{ ocp4_workload_litemaas_litellm_tag }}"
                    ports:
                      - containerPort: 4000
                        name: http
                    env:
                      - name: DATABASE_URL
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: DATABASE_URL
                      - name: LITELLM_MASTER_KEY
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: LITELLM_MASTER_KEY
                      - name: UI_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: UI_USERNAME
                      - name: UI_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: UI_PASSWORD
                    livenessProbe:
                      httpGet:
                        path: /health/livenessz
                        port: 4000
                      initialDelaySeconds: 30
                      periodSeconds: 15
                      timeoutSeconds: 5
                      failureThreshold: 3
                    readinessProbe:
                      httpGet:
                        path: /health/readiness
                        port: 4000
                      initialDelaySeconds: 10
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                    resources:
                      limits:
                        memory: "{{ ocp4_workload_litemaas_litellm_memory_limit }}"
                        cpu: "{{ ocp4_workload_litemaas_litellm_cpu_limit }}"
                      requests:
                        memory: "512Mi"
                        cpu: "500m"

    - name: Create LiteLLM service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: litellm
            labels:
              app: litellm
          spec:
            ports:
              - port: 4000
                targetPort: 4000
                name: http
            selector:
              app: litellm

    - name: Create LiteLLM route
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: litellm
            labels:
              app: litellm
          spec:
            host: "litellm-{{ ocp4_workload_litemaas_route_name }}.{{ ocp4_workload_litemaas_cluster_domain }}"
            to:
              kind: Service
              name: litellm
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect

- name: Configure Redis for LiteLLM
  when:
    - ocp4_workload_litemaas_deploy_redis | bool
    - not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Add Redis environment variables to LiteLLM deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: litellm
          spec:
            template:
              spec:
                containers:
                  - name: litellm
                    env:
                      - name: DATABASE_URL
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: DATABASE_URL
                      - name: LITELLM_MASTER_KEY
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: LITELLM_MASTER_KEY
                      - name: UI_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: UI_USERNAME
                      - name: UI_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: litellm-secret
                            key: UI_PASSWORD
                      - name: REDIS_HOST
                        value: litemaas-redis
                      - name: REDIS_PORT
                        value: "6379"
                      - name: REDIS_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: redis-enterprise-secret
                            key: password
                      - name: CACHE_TYPE
                        value: redis

    - name: Wait for Redis init container
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: litellm
          spec:
            template:
              spec:
                initContainers:
                  - name: wait-for-postgres
                    image: busybox:1.36
                    command:
                      - sh
                      - -c
                      - |
                        until nc -z postgres 5432; do
                          echo "Waiting for PostgreSQL..."
                          sleep 2
                        done
                        echo "PostgreSQL is ready"
                  - name: wait-for-redis
                    image: busybox:1.36
                    command:
                      - sh
                      - -c
                      - |
                        until nc -z litemaas-redis 6379; do
                          echo "Waiting for Redis..."
                          sleep 2
                        done
                        echo "Redis is ready"

- name: Deploy LiteMaaS Frontend
  when:
    - ocp4_workload_litemaas_deploy_frontend | bool
    - not (ocp4_workload_litemaas_multi_user | bool)
  block:
    - name: Create frontend deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: litemaas-frontend
            labels:
              app: litemaas-frontend
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: litemaas-frontend
            template:
              metadata:
                labels:
                  app: litemaas-frontend
              spec:
                containers:
                  - name: frontend
                    image: "{{ ocp4_workload_litemaas_frontend_image }}:{{ ocp4_workload_litemaas_version }}"
                    ports:
                      - containerPort: 8080
                        name: http
                    env:
                      - name: BACKEND_URL
                        value: "http://litemaas-backend:3000"
                    resources:
                      limits:
                        memory: "{{ ocp4_workload_litemaas_frontend_memory_limit }}"
                        cpu: "{{ ocp4_workload_litemaas_frontend_cpu_limit }}"
                      requests:
                        memory: "128Mi"
                        cpu: "100m"

    - name: Create frontend service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: litemaas-frontend
            labels:
              app: litemaas-frontend
          spec:
            ports:
              - port: 8080
                targetPort: 8080
                name: http
            selector:
              app: litemaas-frontend

    - name: Create frontend route
      kubernetes.core.k8s:
        state: present
        namespace: "{{ ocp4_workload_litemaas_namespace }}"
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: litemaas-frontend
            labels:
              app: litemaas-frontend
          spec:
            host: "litemaas-rhpds.{{ ocp4_workload_litemaas_cluster_domain }}"
            to:
              kind: Service
              name: litemaas-frontend
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
