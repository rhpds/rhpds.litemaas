---
# Configure LiteLLM models via API after deployment
# Now uses the dedicated ocp4_workload_litemaas_models role

- name: Configure models using dedicated models role
  when: ocp4_workload_litemaas_litellm_models | length > 0
  block:
    - name: Get LiteLLM master key
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        namespace: "{{ _litemaas_namespace }}"
        name: litellm-secret
      register: r_litellm_secret

    - name: Get LiteLLM route hostname
      kubernetes.core.k8s_info:
        api_version: route.openshift.io/v1
        kind: Route
        namespace: "{{ _litemaas_namespace }}"
        name: litemaas
      register: r_litellm_route

    - name: Run model management role
      ansible.builtin.include_role:
        name: rhpds.litemaas.ocp4_workload_litemaas_models
      vars:
        litellm_url: "https://{{ r_litellm_route.resources[0].spec.host }}"
        litellm_master_key: "{{ r_litellm_secret.resources[0].data.LITELLM_MASTER_KEY | b64decode }}"
        ocp4_workload_litemaas_models_namespace: "{{ _litemaas_namespace }}"
        ocp4_workload_litemaas_models_list: "{{ ocp4_workload_litemaas_litellm_models }}"
        ocp4_workload_litemaas_models_backend_enabled: "{{ ocp4_workload_litemaas_deploy_backend }}"
        ocp4_workload_litemaas_models_sync_from_litellm: false
