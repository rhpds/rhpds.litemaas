---
# Post-deployment validation and info

- name: Get actual PostgreSQL password from running pod
  ansible.builtin.shell: |
    oc exec -n {{ ocp4_workload_litemaas_namespace }} statefulset/postgres -- printenv POSTGRES_PASSWORD
  register: r_actual_pg_password
  changed_when: false

- name: Set actual PostgreSQL password as fact
  ansible.builtin.set_fact:
    _litemaas_actual_postgres_password: "{{ r_actual_pg_password.stdout | trim }}"

- name: Create LiteLLM database using oc exec with actual password
  ansible.builtin.shell: |
    oc exec -n {{ ocp4_workload_litemaas_namespace }} statefulset/postgres -- bash -c "
    export PGPASSWORD='{{ _litemaas_actual_postgres_password }}'
    psql -U litemaas -d postgres -c 'DROP DATABASE IF EXISTS litellm_db;'
    psql -U litemaas -d postgres -c 'CREATE DATABASE litellm_db OWNER litemaas;'
    echo 'LiteLLM database created successfully'
    "
  register: r_db_creation
  failed_when: false

- name: Display database creation result
  ansible.builtin.debug:
    msg: "{{ r_db_creation.stdout_lines }}"

- name: Check if litellm-secret already exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    name: litellm-secret
  register: r_existing_litellm_secret

- name: Reuse existing LiteLLM credentials if available
  when: r_existing_litellm_secret.resources | length > 0
  ansible.builtin.set_fact:
    _litemaas_litellm_master_key: "{{ r_existing_litellm_secret.resources[0].data.LITELLM_MASTER_KEY | b64decode }}"
    _litemaas_litellm_ui_username: "{{ r_existing_litellm_secret.resources[0].data.UI_USERNAME | b64decode }}"
    _litemaas_litellm_ui_password: "{{ r_existing_litellm_secret.resources[0].data.UI_PASSWORD | b64decode }}"

- name: Generate new LiteLLM credentials if needed
  when: r_existing_litellm_secret.resources | length == 0
  ansible.builtin.set_fact:
    _litemaas_litellm_master_key: "{{ ocp4_workload_litemaas_litellm_api_key }}"
    _litemaas_litellm_ui_username: "{{ ocp4_workload_litemaas_litellm_ui_username }}"
    _litemaas_litellm_ui_password: "{{ ocp4_workload_litemaas_litellm_ui_password }}"

- name: Update litellm-secret with DATABASE_URL using actual password
  kubernetes.core.k8s:
    state: present
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: litellm-secret
        labels:
          app: litellm
      type: Opaque
      stringData:
        LITELLM_MASTER_KEY: "{{ _litemaas_litellm_master_key }}"
        UI_USERNAME: "{{ _litemaas_litellm_ui_username }}"
        UI_PASSWORD: "{{ _litemaas_litellm_ui_password }}"
        DATABASE_URL: "postgresql://litemaas:{{ _litemaas_actual_postgres_password }}@postgres:5432/litellm_db?sslmode=disable"

- name: Update LiteLLM deployment with database environment variables
  kubernetes.core.k8s:
    state: present
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: litellm
        labels:
          app: litellm
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: litellm
        template:
          metadata:
            labels:
              app: litellm
          spec:
            containers:
              - name: litellm
                image: "{{ ocp4_workload_litemaas_litellm_image }}:{{ ocp4_workload_litemaas_litellm_tag }}"
                ports:
                  - containerPort: 4000
                    name: http
                env:
                  - name: LITELLM_MASTER_KEY
                    valueFrom:
                      secretKeyRef:
                        name: litellm-secret
                        key: LITELLM_MASTER_KEY
                  - name: UI_USERNAME
                    valueFrom:
                      secretKeyRef:
                        name: litellm-secret
                        key: UI_USERNAME
                  - name: UI_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: litellm-secret
                        key: UI_PASSWORD
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: litellm-secret
                        key: DATABASE_URL
                  - name: STORE_MODEL_IN_DB
                    value: "True"
                  - name: LITELLM_MODE
                    value: "PRODUCTION"
                resources:
                  limits:
                    memory: "{{ ocp4_workload_litemaas_litellm_memory_limit }}"
                    cpu: "{{ ocp4_workload_litemaas_litellm_cpu_limit }}"
                  requests:
                    memory: "512Mi"
                    cpu: "500m"

- name: Wait for all deployments to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    name: "{{ item }}"
  register: r_deployment
  until:
    - r_deployment.resources | length > 0
    - r_deployment.resources[0].status.readyReplicas is defined
    - r_deployment.resources[0].status.readyReplicas == 1
  retries: 30
  delay: 10
  loop:
    - litemaas-backend
    - litemaas-frontend
    - litellm

- name: Get frontend route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    name: litemaas-frontend
  register: r_frontend_route

- name: Get LiteLLM route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ ocp4_workload_litemaas_namespace }}"
    name: litellm
  register: r_litellm_route

- name: Display access information (debug)
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "LiteMaaS Deployment Complete!"
      - "========================================="
      - "Frontend URL: https://{{ r_frontend_route.resources[0].spec.host }}"
      - "LiteLLM Admin: https://{{ r_litellm_route.resources[0].spec.host }}"
      - ""
      - "LiteLLM Admin Credentials:"
      - "  Username: {{ _litemaas_litellm_ui_username }}"
      - "  Password: {{ _litemaas_litellm_ui_password }}"
      - "========================================="

- name: AgnosticD user info - LiteMaaS URLs
  agnosticd_user_info:
    msg: "LiteMaaS Frontend: https://{{ r_frontend_route.resources[0].spec.host }}"

- name: AgnosticD user info - LiteLLM Admin URL
  agnosticd_user_info:
    msg: "LiteLLM Admin Portal: https://{{ r_litellm_route.resources[0].spec.host }}"

- name: AgnosticD user info - LiteLLM credentials
  agnosticd_user_info:
    msg: "LiteLLM Admin Login: {{ _litemaas_litellm_ui_username }} / {{ _litemaas_litellm_ui_password }}"

- name: AgnosticD user info - OpenShift login instructions
  agnosticd_user_info:
    msg: "User Portal Login: Use 'Login with OpenShift' with your cluster credentials"

- name: AgnosticD provision data - Frontend URL
  agnosticd_user_info:
    data:
      litemaas_frontend_url: "https://{{ r_frontend_route.resources[0].spec.host }}"

- name: AgnosticD provision data - LiteLLM Admin URL
  agnosticd_user_info:
    data:
      litellm_admin_url: "https://{{ r_litellm_route.resources[0].spec.host }}"

- name: AgnosticD provision data - LiteLLM credentials
  agnosticd_user_info:
    data:
      litellm_admin_username: "{{ _litemaas_litellm_ui_username }}"
      litellm_admin_password: "{{ _litemaas_litellm_ui_password }}"

- name: AgnosticD provision data - Admin API key
  agnosticd_user_info:
    data:
      litemaas_admin_api_key: "{{ ocp4_workload_litemaas_admin_api_key }}"

- name: AgnosticD provision data - Deployment details
  agnosticd_user_info:
    data:
      litemaas_namespace: "{{ ocp4_workload_litemaas_namespace }}"
      litemaas_version: "{{ ocp4_workload_litemaas_version }}"
      cloud_provider: "{{ ocp4_workload_litemaas_cloud_provider }}"
      storage_class: "{{ ocp4_workload_litemaas_postgres_storage_class }}"

- name: Save deployment info to file
  ansible.builtin.copy:
    content: |
      LiteMaaS Deployment Information
      ================================

      Frontend URL: https://{{ r_frontend_route.resources[0].spec.host }}
      LiteLLM Admin: https://{{ r_litellm_route.resources[0].spec.host }}

      LiteLLM Admin Credentials:
        Username: {{ _litemaas_litellm_ui_username }}
        Password: {{ _litemaas_litellm_ui_password }}

      Admin API Key: {{ ocp4_workload_litemaas_admin_api_key }}

      Deployment Details:
        Namespace: {{ ocp4_workload_litemaas_namespace }}
        Version: {{ ocp4_workload_litemaas_version }}
        Cloud Provider: {{ ocp4_workload_litemaas_cloud_provider }}
        Storage Class: {{ ocp4_workload_litemaas_postgres_storage_class }}
        Cluster Domain: {{ ocp4_workload_litemaas_cluster_domain }}
    dest: "{{ ansible_env.HOME }}/litemaas-deployment-info.txt"
    mode: '0600'
  when: ansible_env.HOME is defined
