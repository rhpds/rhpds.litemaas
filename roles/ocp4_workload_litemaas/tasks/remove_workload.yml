---
# Workload removal tasks

- name: Display removal header
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Removing LiteMaaS Workload"
      - "========================================="

- name: Remove multi-user LiteMaaS instances
  when: ocp4_workload_litemaas_multi_user | bool
  block:
    - name: Display multi-user removal info
      ansible.builtin.debug:
        msg:
          - "Removing {{ num_users }} user namespaces"
          - "Pattern: litemaas-{{ ocp4_workload_litemaas_user_prefix }}1 to litemaas-{{ ocp4_workload_litemaas_user_prefix }}{{ num_users }}"

    - name: Remove namespace for each user
      loop: "{{ range(1, num_users | int + 1) | list }}"
      loop_control:
        loop_var: user_number
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Namespace
        name: "litemaas-{{ ocp4_workload_litemaas_user_prefix }}{{ user_number }}"
        wait: true
        wait_timeout: 300

    - name: Display multi-user removal complete
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Multi-User LiteMaaS Removal Complete"
          - "========================================="
          - "Removed {{ num_users }} user namespaces"
          - "========================================="

- name: Remove OAuth client
  when:
    - not (ocp4_workload_litemaas_multi_user | bool)
    - ocp4_workload_litemaas_oauth_enabled | bool
  kubernetes.core.k8s:
    state: absent
    api_version: oauth.openshift.io/v1
    kind: OAuthClient
    name: "{{ ocp4_workload_litemaas_oauth_client_id }}"

# Redis StatefulSet will be removed with namespace deletion

- name: Remove namespace
  when: not (ocp4_workload_litemaas_multi_user | bool)
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Namespace
    name: "{{ ocp4_workload_litemaas_namespace }}"
    wait: true
    wait_timeout: 300

- name: Confirm removal
  when: not (ocp4_workload_litemaas_multi_user | bool)
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "LiteMaaS workload removed successfully"
      - "========================================="
      - "Namespace: {{ ocp4_workload_litemaas_namespace }}"
      - "OAuth Client: {{ ocp4_workload_litemaas_oauth_client_id }}"
      - "========================================="
