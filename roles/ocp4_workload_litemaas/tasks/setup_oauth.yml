---
# OpenShift OAuth Proxy Setup
# This configures OAuth Proxy sidecar to require OpenShift authentication

- name: Setup OpenShift OAuth Proxy
  when: ocp4_workload_litemaas_oauth_proxy_enabled | bool
  block:
    - name: Display OAuth Proxy setup header
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Setting up OpenShift OAuth Proxy"
          - "========================================="
          - "All users must login with OpenShift credentials"

    - name: Set OAuth namespace
      ansible.builtin.set_fact:
        _oauth_namespace: "{{ _litemaas_ha_namespace | default(ocp4_workload_litemaas_namespace) }}"

    - name: Ensure OAuth namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ _oauth_namespace }}"

    - name: Create ServiceAccount for OAuth Proxy
      kubernetes.core.k8s:
        state: present
        namespace: "{{ _oauth_namespace }}"
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: "{{ ocp4_workload_litemaas_oauth_proxy_serviceaccount }}"
            annotations:
              serviceaccounts.openshift.io/oauth-redirectreference.primary: >-
                {"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"litemaas"}}

    - name: Create ClusterRoleBinding for OAuth Proxy
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: "litemaas-oauth-proxy-{{ _oauth_namespace }}"
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:auth-delegator
          subjects:
            - kind: ServiceAccount
              name: "{{ ocp4_workload_litemaas_oauth_proxy_serviceaccount }}"
              namespace: "{{ _oauth_namespace }}"

    - name: Create OAuth Proxy cookie secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ _oauth_namespace }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: litemaas-oauth-proxy-secret
            labels:
              app: litemaas
          type: Opaque
          stringData:
            session_secret: "{{ ocp4_workload_litemaas_oauth_proxy_cookie_secret }}"

    - name: Display OAuth Proxy configuration
      ansible.builtin.debug:
        msg:
          - "OAuth Proxy Configured"
          - "Service Account: {{ ocp4_workload_litemaas_oauth_proxy_serviceaccount }}"
          - "Namespace: {{ _oauth_namespace }}"
          - "Users must authenticate via OpenShift before accessing LiteLLM"

- name: Remove OAuth Proxy configuration
  when:
    - not (ocp4_workload_litemaas_oauth_proxy_enabled | bool)
    - ocp4_workload_litemaas_remove | bool
  block:
    - name: Set OAuth namespace for removal
      ansible.builtin.set_fact:
        _oauth_namespace: "{{ _litemaas_ha_namespace | default(ocp4_workload_litemaas_namespace) }}"

    - name: Remove ClusterRoleBinding
      kubernetes.core.k8s:
        state: absent
        api_version: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        name: "litemaas-oauth-proxy-{{ _oauth_namespace }}"

    - name: Remove ServiceAccount
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ServiceAccount
        name: "{{ ocp4_workload_litemaas_oauth_proxy_serviceaccount }}"
        namespace: "{{ _oauth_namespace }}"

    - name: Remove OAuth Proxy secret
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Secret
        name: litemaas-oauth-proxy-secret
        namespace: "{{ _oauth_namespace }}"
